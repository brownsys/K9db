name: "Tests on Ubuntu"
on: [push]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - name: Dependencies
      run: |
        sudo apt-get install -y gcc-9 g++-9 libsqlite3-dev
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 90 \
                                 --slave /usr/bin/gcc-ar gcc-ar /usr/bin/gcc-ar-9 \
                                 --slave /usr/bin/gcc-nm gcc-nm /usr/bin/gcc-nm-9 \
                                 --slave /usr/bin/gcc-ranlib gcc-ranlib /usr/bin/gcc-ranlib-9 \
                                 --slave /usr/bin/g++ g++ /usr/bin/g++-9
        sudo update-alternatives --set gcc /usr/bin/gcc-9
        sudo apt-get install valgrind
    - name: Information
      run: |
        bazel --version
        g++ --version
        valgrind --version
        java -version
        javac -version

    - name: Test dataflow with valgrind
      run: bazel test //pelton/dataflow/... --config=valgrind

    - name: Build all
      run: bazel build ...

    - name: Test all
      run: bazel test ...

    - name: Run end-2-end sample
      run: |
        rm -rf /tmp/db && mkdir /tmp/db
        bazel run bin:example -- /tmp/db
    - name: Run cli samples
      run: |
        rm -rf db && mkdir db
        valgrind --error-exitcode=1 --errors-for-leak-kinds=definite \
                 --show-leak-kinds=definite ./bazel-bin/bin/cli db \
                 < bin/examples/simple-websubmit.sql
        rm -rf db && mkdir db
        valgrind --error-exitcode=1 --errors-for-leak-kinds=definite \
                 --show-leak-kinds=definite ./bazel-bin/bin/cli db \
                 < bin/examples/medical_chat.sql
    - name: Run social chat with restart/recovery
      run: |
        rm -rf db && mkdir db
        valgrind --error-exitcode=1 --errors-for-leak-kinds=definite \
                 --show-leak-kinds=definite ./bazel-bin/bin/cli db \
                 < bin/examples/social_chat.sql
        valgrind --error-exitcode=1 --errors-for-leak-kinds=definite \
                 --show-leak-kinds=definite ./bazel-bin/bin/cli db \
                 < bin/examples/social_chat.cntd.sql
